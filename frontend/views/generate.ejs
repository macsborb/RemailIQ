<!DOCTYPE html>
<html lang="fr" data-theme="ProspectAI">
<head>
  <meta charset="utf-8">
  <title>ProspectAI - Générer un Mail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />  
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="/js/generate_page.js" defer></script>  
  <script src="/js/manual-mail.js" defer></script>  
  <script src="/js/email-history.js" defer></script>
  <script src="/js/mobile.js" defer></script>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/css/static.css">
</head>
<body class="bg-base-100 text-base-content">
  <style>
    /* Styles pour le drawer (desktop et mobile) */
    .drawer-side {
      position: fixed;
      top: 4rem;
      left: 0;
      width: 20rem;
      height: calc(100vh - 4rem);
      background: var(--b1);
      border-right: 1px solid var(--b3);
      z-index: 40;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
    }

    .drawer-side.show {
      transform: translateX(0);
    }

    /* Styles mobiles */
    @media (max-width: 1024px) {
      .main-content-with-history {
        margin-right: auto !important;
        margin-left: auto !important;
        max-width: 100% !important;
        padding: 1rem !important;
      }
      
      .email-history-panel {
        position: fixed;
        top: 4rem;
        right: 0;
        width: 90%;
        max-width: 24rem;
        height: calc(100vh - 4rem);
        z-index: 40;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        background: var(--b1);
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      }

      .email-history-panel.show {
        transform: translateX(0);
      }

      .drawer-side {
        width: 90% !important;
        max-width: 24rem !important;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      }

      .card, .modal-box {
        border-radius: 0.5rem !important;
        padding: 1rem !important;
      }
      
      .prose {
        font-size: 0.95rem !important;
      }
      
      .btn, .input, .select, .textarea {
        font-size: 0.95rem !important;
        height: auto !important;
        min-height: 2.5rem !important;
      }

      .collapse-content {
        padding: 1rem !important;
      }

      .flex-row {
        flex-direction: column !important;
      }

      .gap-4, .gap-6 {
        gap: 1rem !important;
      }
    }

    @media (max-width: 480px) {
      .main-content-with-history {
        padding: 0.75rem !important;
      }

      .card, .modal-box {
        padding: 0.75rem !important;
      }

      .prose {
        font-size: 0.9rem !important;
      }

      .drawer-content {
        padding-bottom: 4rem !important;
      }

      .modal-box {
        margin: 0.5rem !important;
        width: auto !important;
        min-height: auto !important;
      }
      
      .join {
        flex-direction: row !important;
        flex-wrap: wrap !important;
      }

      .join > .btn {
        flex: 1 1 auto !important;
        min-width: 120px !important;
      }
    }      .drawer-side {
        position: fixed;
        top: 4rem;
        left: 0;
        width: 20rem;
        height: calc(100vh - 4rem);
        background: var(--b1);
        border-right: 1px solid var(--b3);
        z-index: 40;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out !important;
        visibility: visible;
        pointer-events: auto;
      }

      .drawer-side.show {
        transform: translateX(0);
      }

    .history-toggle {
      display: none;
    }

    @media (max-width: 1024px) {
      .history-toggle {
        display: flex;
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 50;
      }
    }

    .contacts-toggle {
      display: none;
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      z-index: 50;
    }

    @media (max-width: 1024px) {
      .contacts-toggle {
        display: flex;
      }
      
      .history-toggle {
        display: flex;
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 50;
      }
    }

    /* Ajuster l'espacement entre les boutons flottants */
    .contacts-toggle, .history-toggle {
      transition: transform 0.2s ease;
    }

    .contacts-toggle:hover, .history-toggle:hover {
      transform: scale(1.1);
    }

    .main-content-with-history {
      margin-right: auto;
      margin-left: auto;
      max-width: 100%;
      min-height: calc(100vh - 4rem);
      height: calc(var(--vh, 1vh) * 100 - 4rem);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 1.5rem;
      transition: margin 0.3s ease-in-out;
    }

    @media (min-width: 1025px) {
      .main-content-with-history {
        margin-right: 24rem;
      }
    }

    .card {
      background: var(--b1);
      border: 1px solid var(--b3);
      transition: all 0.3s ease;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .card {
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }

      .card-body {
        padding: 1rem;
      }
      
      .text-2xl {
        font-size: 1.25rem;
        line-height: 1.75rem;
      }
      
      .text-xl {
        font-size: 1.125rem;
        line-height: 1.5rem;
      }
      
      .text-lg {
        font-size: 1rem;
        line-height: 1.5rem;
      }
    }

    .email-card {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .email-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .form-control {
      width: 100%;
      max-width: 100%;
    }

    .drawer-side {
      background: var(--b1);
      border-left: 1px solid var(--b3);
    }

    .drawer-content {
      scroll-behavior: smooth;
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100);
      overflow-y: auto;
    }

    .modal {
      -webkit-overflow-scrolling: touch;
    }

    .modal-box {
      width: 100%;
      max-width: 32rem;
      max-height: calc(100vh - 2rem);
      max-height: calc((var(--vh, 1vh) * 100) - 2rem);
      margin: 1rem;
      overflow-y: auto;
      background: var(--b1);
      border: 1px solid var(--b3);
    }

    @media (max-width: 640px) {
      .modal-box {
        margin: 0.5rem;
        padding: 1rem;
      }
      
      .form-control {
        gap: 0.5rem;
      }
      
      .label {
        padding: 0.25rem 0;
      }
      
      .join {
        gap: 0.5rem;
      }
      
      .join > * {
        margin: 0 !important;
      }
      
      .collapse-content {
        padding: 0.75rem !important;
      }
    }

    .emotion-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
    }

    .size-selector, .response-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .btn-emotion, .btn-size, .btn-response-type {
      flex: 1;
      min-width: 100px;
    }

    .mobile-nav-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 30;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    @media (max-width: 1024px) {
      .mobile-nav-overlay.show {
        display: block;
        opacity: 1;
      }
      
      .drawer-side {
        z-index: 40;
      }
      
      .navbar {
        padding: 0.5rem;
      }
      
      .navbar-center {
        display: none;
      }
      
      .navbar-end {
        gap: 0.5rem !important;
      }
    }
  </style>
    <% if (!isMailConnected) { %>
    <!-- Modale de connexion mail -->
    <dialog id="mail-connection-modal" class="modal">
      <div class="modal-box bg-base-100">
        <h3 class="font-bold text-lg mb-4">Connectez votre boîte mail</h3>
        <p class="mb-4">Pour générer des réponses personnalisées, connectez votre boîte mail :</p>
        <div class="space-y-4">
          <form method="get" action="/gmail/login" class="w-full">
            <button type="submit" class="btn btn-outline w-full gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
              </svg>
              Connexion avec Google
            </button>
          </form>
          <form method="get" action="/outlook/login" class="w-full">
            <button type="submit" class="btn btn-outline w-full gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512">
                <path d="M96 96H247V247H96" fill="#f24f23"/>
                <path d="M265 96V247H416V96" fill="#7eba03"/>
                <path d="M96 265H247V416H96" fill="#3ca4ef"/>
                <path d="M265 265H416V416H265" fill="#f9ba00"/>
              </svg>
              Connexion avec Microsoft
            </button>
          </form>
          <form method="get" action="/apple/login" class="w-full">
            <button type="submit" class="btn btn-outline w-full gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.88-3.08.41-1.09-.47-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.41C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.19 2.31-.89 3.51-.84 1.54.07 2.7.61 3.44 1.57-3.14 1.88-2.29 5.13.89 6.41-.65 1.29-1.52 2.58-2.92 3.03zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.32 2.32-1.89 4.27-3.74 4.25z"/>
              </svg>
              Connexion avec Apple
            </button>
          </form>
        </div>
        <div class="divider">ou</div>        
          <form method="dialog" class="w-full">
            <button id="open-manual-mail-btn" class="btn btn-ghost w-full">Non merci, continuer sans connexion</button>        
          </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
    <% } %>
    <!-- Modale de saisie manuelle de mail -->    
    <dialog id="manual-mail-modal" class="modal">      
      <div class="modal-box max-w-3xl">        
        <h3 class="font-bold text-lg mb-4">Saisir manuellement vos emails</h3>        
        <p class="mb-4">Copiez-collez ici votre conversation email :</p>                
        <div class="form-control mb-6">          <label class="label">            
          <span class="label-text">Email de l'expéditeur</span>          
        </label>          
        <input type="email" id="manual-sender-email" placeholder="exemple@domaine.com" class="input input-bordered w-full" />        
      </div>        
      <div class="form-control mb-6">          
        <label class="label">            
          <span class="label-text">Votre email</span>          
        </label>          
        <input type="email" id="manual-your-email" placeholder="votre@email.com" class="input input-bordered w-full" />        
      </div>                
      <div class="form-control mb-6">          
        <label class="label">            
          <span class="label-text">Contenu de votre conversation</span>            
          <span class="label-text-alt">Collez les messages du plus récent au plus ancien</span>          
        </label>          
        <textarea id="manual-mail-content" class="textarea textarea-bordered w-full h-64" placeholder="Date: 2023-10-15 10:00&#10;De: contact@exemple.com&#10;À: votre@email.com&#10;&#10;Contenu du message...&#10;&#10;---&#10;&#10;Date: 2023-10-14 14:30&#10;De: votre@email.com&#10;À: contact@exemple.com&#10;&#10;Contenu du message..."></textarea>        
      </div>        
      <div class="flex justify-end gap-2">          
        <form method="dialog" class="w-auto">            
          <button class="btn btn-ghost">Annuler</button>          
        </form>          
        <button id="submit-manual-mail" class="btn btn-primary">Utiliser ces emails</button>        
      </div>      </div>      <form method="dialog" class="modal-backdrop">        
        <button>close</button>      
      </form>    
    </dialog>    <!-- Sidebar -->
    <div class="drawer drawer-mobile">
      <!-- Mobile overlay for drawers -->
      <div class="mobile-nav-overlay"></div>
      <div class="drawer-content">
        <div class="navbar border-b-secondary bg-base-200 shadow-sm fixed top-0 left-0 right-0 z-50">
          <div class="navbar-start">
            <a href="/" class="btn btn-ghost text-xl">ProspectAI</a>
          </div>
          <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
              <li><a class="btn btn-ghost normal-case text-l" href="/dashboard">Dashboard</a></li>
              <li>
                <label class="swap swap-rotate">
                  <input type="checkbox" class="theme-controller" value="dark" />
                  <!-- sun icon -->
                  <svg
                    class="swap-off h-7 w-7 fill-current text-yellow-500"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24">
                    <path
                      d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
                  </svg>
                  <!-- moon icon -->
                  <svg
                    class="swap-on h-7 w-7 fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24">
                    <path
                      d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
                  </svg>
                </label>
              </li>
            </ul>
          </div>
          <div class="navbar-end flex gap-6 items-center">
            <% if (outlookConnected) { %>
              <button id="logout-outlook" class="btn btn-outline btn-error btn-sm">Se déconnecter d'Outlook</button>
              <span class="text-sm">Connecté à : <%= outlookEmail %></span>
            <% } else if (gmailConnected) { %>
              <button id="logout-gmail" class="btn btn-outline btn-error btn-sm">Se déconnecter de Gmail</button>
              <span class="text-sm">Connecté à : <%= gmailEmail %></span>
            <% } else { %>
              <div class="dropdown dropdown-end">
                <button tabindex="0" class="btn bg-[#2F2F2F] text-white border-black">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  Connecter une boîte mail
                </button>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li>
                    <form method="get" action="/gmail/login" class="w-full">
                      <button type="submit" class="w-full flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Gmail
                      </button>
                    </form>
                  </li>
                  <li>
                    <form method="get" action="/outlook/login" class="w-full">
                      <button type="submit" class="w-full flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512">
                          <path d="M96 96H247V247H96" fill="#f24f23"/>
                          <path d="M265 96V247H416V96" fill="#7eba03"/>
                          <path d="M96 265H247V416H96" fill="#3ca4ef"/>
                          <path d="M265 265H416V416H265" fill="#f9ba00"/>
                        </svg>
                        Microsoft Outlook
                </button>
              </form>
                  </li>
                </ul>
              </div>
            <% } %>
            <!-- Avatar Dropdown -->
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                <div class="w-10 rounded-full bg-neutral text-neutral-content flex items-center justify-center overflow-hidden">
                    <% if (typeof userAvatarUrl !== 'undefined' && userAvatarUrl) { %>
                    <img alt="Avatar" src="<%= userAvatarUrl %>" />
                    <% } else if (typeof outlookEmail !== 'undefined' && outlookEmail) { %>
                    <span class="text-lg font-bold"><%= outlookEmail.charAt(0).toUpperCase() %></span>
                    <% } else { %>
                    <span class="text-lg font-bold">?</span>
                    <% } %>
                </div>
              </div>
              <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-1 mt-3 w-52 p-2 shadow">
                <li>
                  <a class="justify-between" href="/profile">
                    Profil
                  </a>
                </li>
                <li>
                  <button class="justify-between" onclick="my_modal_3.showModal()">Prospect AI PLUS<span class="badge">New</span></button>
                  
                </li>
                <li><a href="/settings">Paramètres</a></li>
                <li>
                  <form method="post" action="/logout">
                    <button type="submit" class="w-full text-left">Se déconnecter</button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <dialog id="my_modal_3" class="modal">
          <div class="modal-box">
            <div class="card w-96 bg-base-100 shadow-sm">
              <div class="card-body">
                <span class="badge badge-xs badge-warning">Most Popular</span>
                <div class="flex justify-between">
                  <h2 class="text-3xl font-bold">Premium</h2>
                  <span class="text-xl">10$US/mo</span>
                </div>
                <ul class="mt-6 flex flex-col gap-2 text-xs">
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>Customizable prompt</span>
                  </li>
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>Personalise template button</span>
                  </li>
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>Select your favorite LLM (OpenAI, Mistral, Gemini)</span>
                  </li>
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>100 tokens/day</span>
                  </li>
                  <li class="opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span class="line-through">In app send e-mail</span>
                  </li>
                  <li class="opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4 me-2 inline-block text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span class="line-through">Notification and programmed e-mail send</span>
                  </li>
                </ul>
                <div class="mt-6">
                  <button class="btn btn-primary btn-block">Subscribe</button>
                </div>
              </div>
            </div>
            <form method="dialog">
              <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
          </div>
        </dialog>
        <main class="flex-1 mt-20 mr-20 ml-2 bg-base-100 main-content-with-history">
          <section class="h-full w-full card bg-base-200 p-8 shadow-xl">
            <div class="flex items-center justify-between mb-8">
              <h2 class="text-2xl font-bold text-center flex-1">Générer un nouveau mail</h2>
              <div class="flex gap-2">
                <div class="tooltip tooltip-left" data-tip="Gérer les contacts">
                  <button class="btn btn-circle btn-ghost hover:bg-base-300" onclick="showContacts()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  </button>
                </div>
                <div class="tooltip tooltip-left" data-tip="Besoin d'aide ?">
                  <button class="btn btn-circle btn-ghost hover:bg-base-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 14v2m0-6a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 0V6m0 0a2 2 0 1 1 4 0" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="mb-8" id="alert-div">
              <div class="alert alert-info mb-4 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" />
                </svg>                
                <span>Sélectionnez un mail à gauche pour commencer.</span>
                <button id="show-manual-mail" class="btn btn-sm btn-ghost underline ml-2 hover:bg-base-200">Ou saisissez vos mails manuellement</button>              
              </div>              
            </div>

            <div class="bg-base-100 rounded-lg p-6 mb-8 shadow-md">
              <p id="mail-from" class="text-sm text-gray-500 mb-2"></p>
              <p id="mail-subject" class="text-xl font-semibold mb-4"></p>
              <div id="mail-body" class="prose max-w-none bg-base-200 rounded-lg p-6">                
                <p><em>Aucun contenu pour le moment.</em></p>
              </div>
            </div>

            <div class="space-y-6 mb-8">
              <div class="collapse collapse-plus bg-base-100 shadow-sm">
                <input type="checkbox" />
                <div class="collapse-title text-lg font-semibold">
                  Choisissez le ton de la réponse <span class="badge badge-primary ml-2">2 max</span>
                </div>
                <div class="collapse-content">
                  <div id="emotion-selector" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-2">
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform" data-emotion="Professionnelle">Professionnel</button>
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform"data-emotion="Gentil" >Gentil</button>
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform"data-emotion="Amical">Amical</button>
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform"data-emotion="Frustre">Frustré</button>
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform"data-emotion="Formel">Formel</button>
                    <button class="btn btn-outline btn-emotion hover:scale-105 transition-transform"data-emotion="Enthousiaste">Enthousiaste</button>
                  </div>
                </div>
              </div>

              <div class="form-control w-full max-w-md">
                <label class="label">
                  <span class="label-text text-lg font-semibold">Taille du mail</span>
                </label>
                <div id="size-selector" class="join mt-2 w-full">
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-size="Petite">Petite</button>
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-size="Moyenne">Moyenne</button>
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-size="Grande">Grande</button>
                </div>
              </div>

              <div class="form-control w-full max-w-md">
                <label class="label">
                  <span class="label-text text-lg font-semibold">Type de réponse aux questions</span>
                </label>
                <div id="response-type-selector" class="join mt-2 w-full">
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-response-type="Positive">Positive</button>
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-response-type="Neutral">Neutre</button>
                  <button class="btn btn-outline join-item flex-1 hover:scale-105 transition-transform" data-response-type="Negative">Négative</button>
                </div>
              </div>

              <div class="form-control w-full max-w-md">
                <label class="label">
                  <span class="label-text text-lg font-semibold">Créativité de l'IA</span>
                </label>
                <div class="w-full max-w-xs mx-auto">
                  <div class="flex justify-between px-2.5 mb-1 text-xs">
                    <span class="text-xs text-gray-500">Moins créatif</span>
                    <span class="text-xs text-gray-500">Très créatif</span>
                  </div>
                  <input id="temperature-range" type="range" min="0" max="100" value="25" class="range" step="1" />
                  <div class="flex justify-between px-2.5 mt-2 text-xs">
                    <span>|</span>
                    <span>|</span>
                    <span>|</span>
                    <span>|</span>
                    <span>|</span>
                  </div>
                  <div class="flex justify-between px-2.5 mt-2 text-xs">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                  </div>
                  <div class="text-center mt-2 text-sm">
                    Créativité : <span id="temperature-value">0.25</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-center gap-6">
              <button id="generate-ia" class="btn btn-primary btn-lg btn-wide hover:scale-105 transition-transform">
                <span class="flex items-center gap-2">
                  Générer le mail
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </span>
              </button>
              <span id="ia-loading" class="loading loading-ring loading-lg hidden"></span>
            </div>

            <div id="ia-response" class="mt-8 p-0 bg-base-100 rounded-lg shadow-md hidden">
              <div class="max-w-2xl mx-auto border border-base-300 rounded-lg overflow-hidden">
                <div class="bg-base-200 px-6 py-4 flex flex-col gap-2 border-b border-base-300">
                  <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-6">
                    <div class="flex-1">
                      <div class="text-xs text-gray-500">De :</div>
                      <div class="font-semibold" id="ia-mail-from">
                        <% if (outlookConnected) { %>
                          <%= outlookEmail %>
                        <% } else if (gmailConnected) { %>
                          <%= gmailEmail %>
                        <% } else { %>
                          Votre adresse
                        <% } %>
                      </div>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs text-gray-500">À :</div>
                      <div class="font-semibold" id="ia-mail-to">(Destinataire)</div>
                    </div>
                  </div>
                  <div class="mt-2">
                    <div class="text-xs text-gray-500">Objet :</div>
                    <input type="text" id="ia-mail-subject" class="font-semibold text-base input input-bordered w-full bg-base-100" value="(Objet généré)" />
                  </div>
                </div>
                <div class="px-6 py-6 bg-base-100 min-h-[120px] prose max-w-none" id="ia-mail-body">
                  (Contenu généré)
                </div>
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 px-6 py-4 bg-base-200 border-t border-base-300">
                  <div class="flex gap-2">
                    <button id="copy-ia-response" class="btn btn-outline gap-2 hover:scale-105 transition-transform">
                      <span id="copy-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16h8a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm0 0v2a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2" />
                        </svg>
                      </span>
                      <span id="copy-label">Copier</span>
                    </button>
                    <% if (gmailConnected || outlookConnected) { %>
                    <button id="send-ia-mail" class="btn btn-primary gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      Envoyer ce mail
                    </button>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-center gap-4 mt-6">
              <!-- Ancien bouton copier déplacé dans la carte mail -->
            </div>
          </section>
        </main>

        <!-- Contacts toggle button for mobile -->
        <button class="contacts-toggle btn btn-circle btn-primary shadow-lg" onclick="toggleContactsDrawer()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>

        <!-- History panel toggle for mobile -->
        <button class="history-toggle btn btn-circle btn-primary shadow-lg" onclick="toggleHistoryPanel()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>

        <!-- Panneau d'historique des emails -->
        <div class="email-history-panel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Historique des emails</h3>
            <div class="tooltip tooltip-left" data-tip="Actualiser">
              <button class="btn btn-circle btn-ghost btn-sm" id="refresh-history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
            </div>
          </div>

          <div class="divider my-2"></div>

          <div id="email-history-list" class="space-y-4 overflow-y-auto">
            <!-- Les emails s'afficheront ici via JavaScript -->
            <div class="flex items-center justify-center h-40">
              <p class="text-base-content/70">Chargement de votre historique...</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal des contacts -->
      <dialog id="contacts_modal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl bg-base-100">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Contacts</h3>
            <form method="dialog">
              <button class="btn btn-sm btn-circle btn-ghost">✕</button>
            </form>
          </div>
          
          <div class="mb-2 flex items-center gap-2">
            <label for="contacts-limit-select" class="text-xs">Charger&nbsp;:</label>
            <select id="contacts-limit-select" class="select select-xs select-bordered">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
            </select>
            <span class="text-xs">contacts</span>
          </div>

          <div class="form-control mb-4">
            <input type="text" id="search-bar" placeholder="Rechercher un contact..." class="input input-bordered w-full" />
          </div>

          <div id="contacts-counter" class="text-xs text-right mb-2 text-gray-500"></div>
          
          <div id="contact-list-outlook" class="max-h-[60vh] overflow-y-auto">
            <div class="flex items-center justify-center p-4 text-base-content/70">
              <span class="loading loading-spinner loading-md mr-2"></span>
              Chargement des contacts...
            </div>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop bg-base-300">
          <button>close</button>
        </form>
      </dialog>

  <!-- Modal pour afficher le message complet -->
  <dialog id="message-modal" class="modal">
    <div class="modal-box max-w-5xl">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="modal-from" class="text-lg font-bold"></h3>
          <p id="modal-date" class="text-sm text-gray-500"></p>
        </div>
        <form method="dialog">
          <button class="btn btn-circle btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </form>
      </div>
      <div id="modal-content" class="prose max-w-none"></div>
      <div class="modal-action">
        <button id="modal-select-context" class="btn btn-primary">Utiliser ce message</button>
        <form method="dialog">
          <button class="btn btn-ghost">Fermer</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>Fermer</button>
    </form>
  </dialog>

  <!-- Ajout modale de confirmation d'envoi -->
<dialog id="send-mail-modal" class="modal">
  <div class="modal-box max-w-lg">
    <h3 class="font-bold text-lg mb-4">Envoyer ce mail ?</h3>
    <p class="mb-4">Le mail sera envoyé à <span id="modal-mail-to" class="font-semibold"></span> depuis votre compte connecté.</p>
    <div class="flex justify-end gap-2">
      <form method="dialog"><button class="btn btn-ghost">Annuler</button></form>
      <button id="confirm-send-mail" class="btn btn-primary">Envoyer</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>Fermer</button></form>
</dialog>
</body>
</html>

